<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin หลังบ้าน</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Sarabun", "Noto Sans Thai", "Segoe UI", Tahoma, sans-serif;
      color: #2b2f37;
      background:
        radial-gradient(circle at 10% 0%, rgba(65, 149, 255, 0.16), transparent 45%),
        radial-gradient(circle at 90% 100%, rgba(26, 188, 156, 0.16), transparent 40%),
        #f3f7fb;
      min-height: 100vh;
      padding: 16px;
    }
    .wrap {
      max-width: 1060px;
      margin: 0 auto;
      display: grid;
      gap: 12px;
    }
    .card {
      background: #ffffff;
      border: 1px solid #dce8f5;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(36, 74, 117, 0.09);
      padding: 14px;
    }
    .login-card {
      max-width: 440px;
      margin: 8vh auto 0;
    }
    .title {
      margin: 0;
      font-size: clamp(20px, 3vw, 30px);
      font-weight: 700;
      color: #224461;
    }
    .sub {
      margin: 6px 0 0;
      color: #61758a;
      font-size: 14px;
    }
    .form-grid {
      margin-top: 12px;
      display: grid;
      gap: 10px;
    }
    .label {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: #49627a;
      font-weight: 600;
    }
    .input {
      border: 1px solid #c5d8ec;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      color: #2b2f37;
      background: #fff;
    }
    .input:focus {
      border-color: #4a9fff;
      box-shadow: 0 0 0 3px rgba(74, 159, 255, 0.2);
    }
    .btn {
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-primary {
      background: linear-gradient(120deg, #2f84eb, #2dc19a);
      color: #fff;
    }
    .btn-outline {
      background: #eaf2fb;
      color: #244b6c;
    }
    .message {
      min-height: 20px;
      margin: 10px 0 0;
      color: #607488;
      font-size: 13px;
    }
    .message.error {
      color: #c03c58;
    }
    .hint {
      margin: 8px 0 0;
      font-size: 12px;
      color: #7b8b9b;
    }
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .toolbar-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tag {
      padding: 6px 10px;
      border-radius: 999px;
      background: #e8f1fb;
      color: #255079;
      font-size: 12px;
      font-weight: 700;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }
    .stat {
      border: 1px solid #d9e7f6;
      border-radius: 12px;
      background: #f8fbff;
      padding: 10px;
      display: grid;
      gap: 2px;
      color: #4a6076;
      font-size: 12px;
    }
    .stat strong {
      font-size: 21px;
      color: #1f4667;
      line-height: 1;
    }
    .orders {
      display: grid;
      gap: 10px;
    }
    .order-card {
      border: 1px solid #d7e5f4;
      border-radius: 14px;
      background: #fff;
      padding: 12px;
      display: grid;
      gap: 10px;
    }
    .order-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
    .order-id {
      margin: 0;
      font-size: 20px;
      color: #204667;
      font-weight: 700;
    }
    .order-meta {
      margin: 3px 0 0;
      color: #62788d;
      font-size: 13px;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      min-width: 86px;
    }
    .status-pending { background: #f29f05; }
    .status-preparing { background: #1f88e5; }
    .status-served { background: #14a56a; }
    .status-cancelled { background: #c75353; }
    .items {
      display: grid;
      gap: 6px;
    }
    .item-row {
      display: grid;
      grid-template-columns: 40px 1fr auto;
      gap: 8px;
      align-items: center;
      border: 1px solid #dfebf7;
      border-radius: 10px;
      padding: 6px 8px;
    }
    .item-img {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      background: #f2f7fd;
      border: 1px solid #dce9f7;
    }
    .item-name {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
      color: #2d4760;
    }
    .item-sub {
      margin: 2px 0 0;
      font-size: 12px;
      color: #6b7f93;
    }
    .item-sum {
      font-size: 13px;
      font-weight: 700;
      color: #294965;
    }
    .order-foot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .order-total {
      font-size: 16px;
      font-weight: 700;
      color: #1e4565;
    }
    .status-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-select {
      border: 1px solid #c4d9ee;
      border-radius: 8px;
      padding: 7px 8px;
      font-size: 13px;
      background: #fff;
      color: #244865;
    }
    .empty {
      text-align: center;
      border: 1px dashed #bfd3e8;
      border-radius: 12px;
      padding: 22px 12px;
      color: #71869a;
      background: #f9fcff;
    }
    .hidden {
      display: none !important;
    }
    @media (max-width: 760px) {
      body { padding: 10px; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-actions { justify-content: space-between; }
      .stats {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .order-id { font-size: 18px; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section id="loginView" class="card login-card">
      <h1 class="title">ระบบหลังบ้านแอดมิน</h1>
      <p class="sub">รับออเดอร์ลูกค้าแบบเรียลไทม์</p>

      <form id="loginForm" class="form-grid">
        <label class="label">
          ชื่อผู้ใช้
          <input id="usernameInput" class="input" type="text" autocomplete="username" required>
        </label>
        <label class="label">
          รหัสผ่าน
          <input id="passwordInput" class="input" type="password" autocomplete="current-password" required>
        </label>
        <button id="loginBtn" class="btn btn-primary" type="submit">เข้าสู่ระบบ</button>
      </form>

      <p id="loginMessage" class="message"></p>
      <p class="hint">ค่าเริ่มต้น: admin / admin123</p>
    </section>

    <section id="dashboardView" class="hidden">
      <header class="card toolbar">
        <div>
          <h2 class="title">ออเดอร์เรียลไทม์</h2>
          <p id="connectionState" class="sub">สถานะ: -</p>
        </div>
        <div class="toolbar-actions">
          <span id="adminTag" class="tag">Admin</span>
          <button id="logoutBtn" class="btn btn-outline" type="button">ออกจากระบบ</button>
        </div>
      </header>

      <section class="card stats">
        <article class="stat"><strong id="countAll">0</strong><span>ทั้งหมด</span></article>
        <article class="stat"><strong id="countPending">0</strong><span>รอรับออเดอร์</span></article>
        <article class="stat"><strong id="countPreparing">0</strong><span>กำลังเตรียม</span></article>
        <article class="stat"><strong id="countServed">0</strong><span>เสิร์ฟแล้ว</span></article>
      </section>

      <section id="ordersList" class="orders card"></section>
    </section>
  </main>

  <script>
    "use strict";

    var STATUS_OPTIONS = [
      { value: "pending", label: "รอรับออเดอร์" },
      { value: "preparing", label: "กำลังเตรียม" },
      { value: "served", label: "เสิร์ฟแล้ว" },
      { value: "cancelled", label: "ยกเลิก" }
    ];

    var token = localStorage.getItem("admin_token") || "";
    var adminName = localStorage.getItem("admin_name") || "";
    var orders = [];
    var stream = null;

    var loginViewEl = document.getElementById("loginView");
    var dashboardViewEl = document.getElementById("dashboardView");
    var loginFormEl = document.getElementById("loginForm");
    var usernameInputEl = document.getElementById("usernameInput");
    var passwordInputEl = document.getElementById("passwordInput");
    var loginBtnEl = document.getElementById("loginBtn");
    var loginMessageEl = document.getElementById("loginMessage");
    var connectionStateEl = document.getElementById("connectionState");
    var adminTagEl = document.getElementById("adminTag");
    var logoutBtnEl = document.getElementById("logoutBtn");
    var ordersListEl = document.getElementById("ordersList");
    var countAllEl = document.getElementById("countAll");
    var countPendingEl = document.getElementById("countPending");
    var countPreparingEl = document.getElementById("countPreparing");
    var countServedEl = document.getElementById("countServed");

    function escapeHtml(text) {
      return String(text || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function formatPrice(price) {
      return "฿" + Number(price || 0).toLocaleString("th-TH");
    }

    function formatDateTime(value) {
      if (!value) return "-";
      return String(value);
    }

    function getStatusLabel(status) {
      var i;
      for (i = 0; i < STATUS_OPTIONS.length; i += 1) {
        if (STATUS_OPTIONS[i].value === status) {
          return STATUS_OPTIONS[i].label;
        }
      }
      return status || "-";
    }

    function setLoginMessage(message, isError) {
      loginMessageEl.textContent = message || "";
      if (isError) {
        loginMessageEl.classList.add("error");
      } else {
        loginMessageEl.classList.remove("error");
      }
    }

    function setConnectionState(message) {
      connectionStateEl.textContent = "สถานะ: " + message;
    }

    function showLogin() {
      dashboardViewEl.classList.add("hidden");
      loginViewEl.classList.remove("hidden");
      setConnectionState("-");
    }

    function showDashboard() {
      loginViewEl.classList.add("hidden");
      dashboardViewEl.classList.remove("hidden");
      adminTagEl.textContent = adminName ? "@" + adminName : "Admin";
    }

    function resetSession() {
      token = "";
      adminName = "";
      localStorage.removeItem("admin_token");
      localStorage.removeItem("admin_name");
      if (stream) {
        stream.close();
        stream = null;
      }
    }

    async function apiRequest(url, options) {
      var opts = options || {};
      var headers = Object.assign({}, opts.headers || {});
      if (!headers["Content-Type"] && opts.body) {
        headers["Content-Type"] = "application/json";
      }
      if (token) {
        headers.Authorization = "Bearer " + token;
      }

      var response = await fetch(url, Object.assign({}, opts, { headers: headers }));
      var data = null;
      try {
        data = await response.json();
      } catch (e) {
        data = null;
      }

      if (!response.ok) {
        if (response.status === 401) {
          resetSession();
          showLogin();
          setLoginMessage("Session หมดอายุ กรุณาเข้าสู่ระบบใหม่", true);
        }
        throw new Error((data && data.message) || "Request failed");
      }

      return data || {};
    }

    function updateStats() {
      var pending = 0;
      var preparing = 0;
      var served = 0;

      orders.forEach(function (order) {
        if (order.status === "pending") pending += 1;
        if (order.status === "preparing") preparing += 1;
        if (order.status === "served") served += 1;
      });

      countAllEl.textContent = orders.length;
      countPendingEl.textContent = pending;
      countPreparingEl.textContent = preparing;
      countServedEl.textContent = served;
    }

    function renderOrders() {
      updateStats();

      if (!orders.length) {
        ordersListEl.innerHTML = '<div class="empty">ยังไม่มีออเดอร์</div>';
        return;
      }

      ordersListEl.innerHTML = orders.map(function (order) {
        var items = Array.isArray(order.items) ? order.items : [];
        var itemsHtml = items.map(function (item) {
          var img = item.image && String(item.image).trim()
            ? String(item.image)
            : "https://via.placeholder.com/80x80?text=MENU";

          return (
            '<div class="item-row">' +
              '<img class="item-img" src="' + escapeHtml(img) + '" alt="' + escapeHtml(item.name) + '">' +
              "<div>" +
                '<p class="item-name">' + escapeHtml(item.name) + "</p>" +
                '<p class="item-sub">' + formatPrice(item.price) + " x " + Number(item.qty || 0) + "</p>" +
              "</div>" +
              '<span class="item-sum">' + formatPrice(Number(item.price || 0) * Number(item.qty || 0)) + "</span>" +
            "</div>"
          );
        }).join("");

        var statusOptions = STATUS_OPTIONS.map(function (option) {
          var selected = option.value === order.status ? " selected" : "";
          return '<option value="' + option.value + '"' + selected + ">" + option.label + "</option>";
        }).join("");

        return (
          '<article class="order-card">' +
            '<header class="order-head">' +
              "<div>" +
                '<h3 class="order-id">Order #' + Number(order.id || 0) + "</h3>" +
                '<p class="order-meta">ลูกค้า: ' + escapeHtml(order.customerName || "ลูกค้า") + " | โต๊ะ: " + escapeHtml(order.tableNo || "-") + "</p>" +
                '<p class="order-meta">เวลา: ' + escapeHtml(formatDateTime(order.createdAt)) + "</p>" +
                '<p class="order-meta">โน้ต: ' + escapeHtml(order.note || "-") + "</p>" +
              "</div>" +
              '<span class="status-badge status-' + escapeHtml(order.status || "pending") + '">' + escapeHtml(getStatusLabel(order.status)) + "</span>" +
            "</header>" +
            '<section class="items">' + itemsHtml + "</section>" +
            '<footer class="order-foot">' +
              '<strong class="order-total">รวม ' + formatPrice(order.total) + "</strong>" +
              '<div class="status-actions">' +
                '<select id="status-' + Number(order.id || 0) + '" class="status-select">' + statusOptions + "</select>" +
                '<button class="btn btn-outline status-save-btn" type="button" data-id="' + Number(order.id || 0) + '">อัปเดต</button>' +
              "</div>" +
            "</footer>" +
          "</article>"
        );
      }).join("");
    }

    function upsertOrder(order) {
      if (!order || !order.id) {
        return;
      }

      var index = -1;
      var i;
      for (i = 0; i < orders.length; i += 1) {
        if (Number(orders[i].id) === Number(order.id)) {
          index = i;
          break;
        }
      }

      if (index >= 0) {
        orders[index] = order;
      } else {
        orders.unshift(order);
      }

      orders.sort(function (a, b) {
        return Number(b.id || 0) - Number(a.id || 0);
      });
      renderOrders();
    }

    async function refreshOrders() {
      var data = await apiRequest("/api/admin/orders");
      orders = Array.isArray(data.orders) ? data.orders : [];
      renderOrders();
    }

    function connectStream() {
      if (!token) {
        return;
      }
      if (stream) {
        stream.close();
        stream = null;
      }

      stream = new EventSource("/api/admin/orders/stream?token=" + encodeURIComponent(token));
      stream.addEventListener("ready", function () {
        setConnectionState("ออนไลน์");
      });
      stream.addEventListener("order", function (event) {
        try {
          var payload = JSON.parse(event.data || "{}");
          if (payload && payload.order) {
            upsertOrder(payload.order);
          }
        } catch (error) {
          // no-op
        }
      });
      stream.onerror = function () {
        setConnectionState("กำลังเชื่อมต่อใหม่...");
      };
    }

    loginFormEl.addEventListener("submit", async function (event) {
      event.preventDefault();
      loginBtnEl.disabled = true;
      setLoginMessage("กำลังเข้าสู่ระบบ...", false);

      try {
        var payload = {
          username: String(usernameInputEl.value || "").trim(),
          password: String(passwordInputEl.value || "")
        };
        var result = await apiRequest("/api/admin/login", {
          method: "POST",
          body: JSON.stringify(payload)
        });

        token = result.token || "";
        adminName = result.admin && result.admin.username ? result.admin.username : "";
        localStorage.setItem("admin_token", token);
        localStorage.setItem("admin_name", adminName);

        setLoginMessage("", false);
        showDashboard();
        await refreshOrders();
        connectStream();
      } catch (error) {
        setLoginMessage(error.message || "เข้าสู่ระบบไม่สำเร็จ", true);
      } finally {
        loginBtnEl.disabled = false;
      }
    });

    ordersListEl.addEventListener("click", async function (event) {
      var target = event.target;
      while (target && target !== ordersListEl && target.getAttribute) {
        if (target.className && String(target.className).indexOf("status-save-btn") !== -1) {
          var orderId = Number(target.getAttribute("data-id"));
          var selectEl = document.getElementById("status-" + orderId);
          if (!selectEl || !orderId) {
            return;
          }

          target.disabled = true;
          try {
            var response = await apiRequest("/api/admin/orders/" + orderId + "/status", {
              method: "PATCH",
              body: JSON.stringify({ status: selectEl.value })
            });
            if (response && response.order) {
              upsertOrder(response.order);
            }
          } catch (error) {
            alert(error.message || "อัปเดตสถานะไม่สำเร็จ");
          } finally {
            target.disabled = false;
          }
          return;
        }
        target = target.parentNode;
      }
    });

    logoutBtnEl.addEventListener("click", function () {
      resetSession();
      showLogin();
      setLoginMessage("ออกจากระบบแล้ว", false);
    });

    async function bootstrap() {
      if (!token) {
        showLogin();
        return;
      }

      try {
        showDashboard();
        await refreshOrders();
        connectStream();
      } catch (error) {
        resetSession();
        showLogin();
      }
    }
// กฟไกฟฟไกฟไกฟไกฟไกไฟก
    bootstrap();
  </script>
</body>
</html>
